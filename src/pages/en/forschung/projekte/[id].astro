---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import labels from '../../../../content/labels.json';
import RelatedPublications from '../../../../components/RelatedPublications.astro';
import StatusBadge from '../../../../components/StatusBadge.astro';

export async function getStaticPaths() {
  const projects = (await getCollection('forschungsprojekte')).filter(p => p.id.startsWith('en/'));
  return projects.map((project) => ({
    params: { id: project.id.replace('en/', '') },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);
const lang = 'en';
const t = labels[lang];

// Get the focus area if this project has one (match without .md extension)
let focusArea = null;
if (project.data.focus_area) {
  const allFocusAreas = await getCollection('forschungsschwerpunkte');
  focusArea = allFocusAreas.find(
    (fa) => fa.id.replace(`${lang}/`, '').replace(/\.md$/, '') === project.data.focus_area
  );
}

// Collect metadata items
const metaItems = [
  { icon: 'user', label: t.labels.projectLead, value: project.data.lead },
  { icon: 'team', label: t.labels.team, value: project.data.team },
  { icon: 'funding', label: t.labels.funding, value: project.data.funding },
  { icon: 'duration', label: t.labels.duration, value: project.data.duration },
  { icon: 'contact', label: t.labels.contact, value: project.data.contact },
].filter(item => item.value);
---

<BaseLayout title={`${project.data.title} - Prof. Dr. Michael Corsten`} lang={lang}>
  <div class="page-container">
    <!-- Back Navigation -->
    <nav class="mb-8">
      <div class="flex flex-wrap items-center gap-2 text-sm">
        <a href={`/Website-Michael-Corsten/en/forschung`} class="text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors flex items-center gap-1.5">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          {t.nav.research}
        </a>
        {focusArea && (
          <>
            <span class="text-slate-300 dark:text-slate-600">/</span>
            <a
              href={`/${lang}/en/forschung/schwerpunkte/${project.data.focus_area}.md`}
              class="text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            >
              {focusArea.data.title}
            </a>
          </>
        )}
      </div>
    </nav>

    <!-- Hero Header -->
    <header class="mb-10">
      {focusArea && (
        <a
          href={`/${lang}/en/forschung/schwerpunkte/${project.data.focus_area}.md`}
          class="inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-wider text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors mb-4"
        >
          <span class="w-2 h-2 rounded-full bg-blue-500"></span>
          {focusArea.data.title}
        </a>
      )}

      <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white tracking-tight leading-tight mb-4">
        {project.data.title}
      </h1>

      <div class="flex items-center gap-2 flex-wrap">
        {project.data.status && <StatusBadge status={project.data.status} />}
        {project.data.years && <span class="text-sm px-2.5 py-1 rounded bg-slate-100 dark:bg-slate-800">{project.data.years}</span>}
      </div>
    </header>

    <!-- Metadata -->
    {metaItems.length > 0 && (
      <div class="flex flex-wrap gap-6 mb-8 text-sm text-slate-600 dark:text-slate-400">
        {metaItems.map((item) => (
          <div class="flex items-center gap-2">
            {item.icon === 'user' && (
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
            )}
            {item.icon === 'team' && (
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
            )}
            {item.icon === 'funding' && (
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
            )}
            {item.icon === 'duration' && (
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            )}
            {item.icon === 'contact' && (
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
            )}
            <span>{item.value}</span>
          </div>
        ))}
      </div>
    )}

    <!-- Main Content -->
    <article class="mb-10">
      <div class="prose dark:prose-invert max-w-none">
        <Content />
      </div>
    </article>

    <!-- Related Publications -->
    {project.data.papers && project.data.papers.length > 0 && (
      <RelatedPublications paperIds={project.data.papers} lang={lang} />
    )}
  </div>
</BaseLayout>
